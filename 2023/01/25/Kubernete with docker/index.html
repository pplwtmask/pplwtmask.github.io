<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Armin">





<title>Kubernete with docker | 星辉的博客</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">⭐辉的博客</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">⭐辉的博客</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Kubernete with docker</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Armin</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">一月 25, 2023&nbsp;&nbsp;15:38:06</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="Kubernete-with-docker"><a href="#Kubernete-with-docker" class="headerlink" title="Kubernete with docker"></a>Kubernete with docker</h2><h3 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/overview/components/#node-components">https://kubernetes.io/zh-cn/docs/concepts/overview/components/#node-components</a></p>
<h3 id="裸机安装"><a href="#裸机安装" class="headerlink" title="裸机安装"></a>裸机安装</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<h4 id="1-安装环境"><a href="#1-安装环境" class="headerlink" title="1.安装环境"></a>1.安装环境</h4><p>安装docker看<a href="http://preferman.github.io/2021/11/28/docker/">查看本博客其它文章</a></p>
<h5 id="安装容器运行时"><a href="#安装容器运行时" class="headerlink" title="安装容器运行时"></a>安装容器运行时</h5><p>Docker Engine 没有实现 CRI， 而这是容器运行时在 Kubernetes 中工作所需要的。 为此，必须安装一个额外的服务 cri-dockerd。 cri-dockerd 是一个基于传统的内置 Docker 引擎支持的项目， 它在 1.24 版本从 kubelet 中移除。</p>
<ol>
<li>根据linux发行版下载二进制文件<a target="_blank" rel="noopener" href="https://github.com/Mirantis/cri-dockerd/releases">地址</a>，也可以自行编译</li>
<li>安装cri-dockerd</li>
<li>执行命令<code>systemctl daemon-reload systemctl enable cri-docker.service systemctl enable --now cri-docker.socket</code><blockquote>
<p>不同linux发行版有所差异</p>
</blockquote>
</li>
</ol>
<h5 id="安装-kubeadm、kubelet-和-kubectl"><a href="#安装-kubeadm、kubelet-和-kubectl" class="headerlink" title="安装 kubeadm、kubelet 和 kubectl"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">安装 kubeadm、kubelet 和 kubectl</a></h5><h4 id="2-配置容器运行时驱动"><a href="#2-配置容器运行时驱动" class="headerlink" title="2.配置容器运行时驱动"></a>2.配置容器运行时驱动</h4><p>k8s使用docker作为容器：</p>
<p>查看当前Docker使用的Cgroup Driver：<br><code>docker info | grep &quot;Cgroup Driver&quot;</code></p>
<p>修改Cgroup Driver</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h4 id="3-初始化控制平面节点"><a href="#3-初始化控制平面节点" class="headerlink" title="3.初始化控制平面节点"></a>3.初始化控制平面节点</h4><h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>选择一个 Pod 网络插件（此时不安装需要传递参数），并验证是否需要为 kubeadm init 传递参数。 根据你选择的第三方网络插件，你可能需要设置 –pod-network-cidr 的值。 请参阅<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">安装 Pod 网络附加组件</a>。<br>本教程使用如下插件：<a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel/">https://github.com/flannel-io/flannel/</a></p>
<p><code>kubeadm init --pod-network-cidr=10.244.0.0/16 --cri-socket=unix:///var/run/cri-dockerd.sock</code></p>
<p>成功的标志:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a Pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  /docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">//加入集群时使用，需要记下来</span><br><span class="line">  kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure>

<h5 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><blockquote>
<p>最好使用香港的服务器，国内其它地方的可能会出现镜像拉去不到的情况，可能是个bug,指定的镜像仓库未生效。<br>解决办法：docker配置能访问外网的代理，<a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/advanced_network/http_https_proxy#wei-dockerd-she-zhi-wang-luo-dai-li">方法</a><br>`Error syncing pod, skipping” err=”failed to &quot;CreatePodSandbox&quot; for &quot;kube-controller-manager-iz8vbia14zbe5y5mt3rka9z_kube-system(786d13527624f9f10ab8c412000ab506)&quot; with CreatePodSandboxError: &quot;Failed to create sandbox for pod \&quot;kube-controller-manager-iz8vbia14zbe5y5mt3rka9z_kube-system(786d13527624f9f10ab8c412000ab506)\&quot;: rpc error: code = Unknown desc = failed pulling image \&quot;registry.k8s.io/pause:3.6\&quot;: Error response from daemon: Head \&quot;<a target="_blank" rel="noopener" href="https://asia-east1-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.6///&quot;">https://asia-east1-docker.pkg.dev/v2/k8s-artifacts-prod/images/pause/manifests/3.6\\\&quot;</a>: dial tcp 64.233.187.82:443: i/o timeout&quot;“ pod=”kube-system/kube-controller-manager-iz8vbia14zbe5y5mt3rka9z” podUID=786d13527624f9f10ab8c412000ab506</p>
</blockquote>
<blockquote>
<p>/usr/bin/kubelet –bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf –kubeconfig=/etc/kubernetes/kubelet.conf –config=/var/lib/kubelet/config.yaml –container-runtime-endpoint=unix:///var/run/cri-dockerd.sock –pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9`</p>
</blockquote>
<h4 id="4-将工作节点加入集群"><a href="#4-将工作节点加入集群" class="headerlink" title="4.将工作节点加入集群"></a>4.将工作节点加入集群</h4><p>在工作节点执行上述init之后生成的命令<code>kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</code></p>
<p>状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ8vbia14zbe5y5mt3rka9Z ~]# kubectl get nodes</span><br><span class="line">NAME                      STATUS     ROLES           AGE   VERSION</span><br><span class="line">iz8vba21wy1jbsrm04fdrbz   NotReady   &lt;none&gt;          25s   v1.26.1</span><br><span class="line">iz8vbia14zbe5y5mt3rka9z   NotReady   control-plane   51m   v1.26.1</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">安装 Pod 网络附加组件</a>：</p>
<p>执行命令：<code>kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</code>。</p>
<p>安装 Pod 网络后，你可以通过在 <code>kubectl get pods --all-namespaces</code> 输出中检查 CoreDNS Pod 是否 Running 来确认其是否正常运行。 一旦 CoreDNS Pod 启用并运行，你就可以继续加入节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ8vbia14zbe5y5mt3rka9Z ~]# kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE      NAME                                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel   kube-flannel-ds-5z22d                             1/1     Running   0          16s</span><br><span class="line">kube-flannel   kube-flannel-ds-c57lm                             1/1     Running   0          16s</span><br><span class="line">kube-system    coredns-787d4945fb-7mz59                          1/1     Running   0          4m1s</span><br><span class="line">kube-system    coredns-787d4945fb-9h7mm                          1/1     Running   0          4m1s</span><br><span class="line">kube-system    etcd-iz8vbia14zbe5y5mt3rka9z                      1/1     Running   0          4m14s</span><br><span class="line">kube-system    kube-apiserver-iz8vbia14zbe5y5mt3rka9z            1/1     Running   0          4m15s</span><br><span class="line">kube-system    kube-controller-manager-iz8vbia14zbe5y5mt3rka9z   1/1     Running   0          4m14s</span><br><span class="line">kube-system    kube-proxy-tfrb5                                  1/1     Running   0          89s</span><br><span class="line">kube-system    kube-proxy-vzf79                                  1/1     Running   0          4m1s</span><br><span class="line">kube-system    kube-scheduler-iz8vbia14zbe5y5mt3rka9z            1/1     Running   0          4m16s</span><br></pre></td></tr></table></figure>


<p>最终状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ8vbia14zbe5y5mt3rka9Z ~]# kubectl get nodes</span><br><span class="line">NAME                      STATUS   ROLES           AGE    VERSION</span><br><span class="line">iz8vba21wy1jbsrm04fdrbz   Ready    &lt;none&gt;          58m    v1.26.1</span><br><span class="line">iz8vbia14zbe5y5mt3rka9z   Ready    control-plane   109m   v1.26.1</span><br></pre></td></tr></table></figure>


<blockquote>
<p>加入集群的节点也需要开启代理（香港服务器轻忽略）,需要拉去镜像</p>
</blockquote>
<h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#remove-the-node">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#remove-the-node</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Armin</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://preferman.github.io/2023/01/25/Kubernete%20with%20docker/">http://preferman.github.io/2023/01/25/Kubernete%20with%20docker/</a></span>
                    </p>
                
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2023/01/30/ping%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E8%BF%87%E7%A8%8B%E5%AE%9E%E8%B7%B5/">ping命令执行的过程实践</a>
            
            
            <a class="next" rel="next" href="/2023/01/24/zookeeper/">zookeeper</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Armin | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>